services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: moongy-sql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "${SQL_SA_PASSWORD}"
      MSSQL_PID: "Developer"
    ports:
      - "1433:1433"
    volumes:
      - sql_data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $$MSSQL_SA_PASSWORD -Q 'SELECT 1' -C || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s

  moongywebapp:
    # Opção A: build local do seu Dockerfile
    build:
      context: .
      dockerfile: Dockerfile
    # Opção B: se já tiver imagem publicada, use:
    # image: your-registry/moongywebapp:latest
    container_name: moongy-web
    depends_on:
      sqlserver:
        condition: service_healthy
      otel-collector:
        condition: service_started
    environment:
      ASPNETCORE_URLS: "http://+:8080"

      # Connection string padrão (igual no Azure, mas apontando pro container do SQL)
      ConnectionStrings__DefaultConnection: "Server=sqlserver,1433;Database=MoongyWebApp-db;User Id=sa;Password=${SQL_SA_PASSWORD};Encrypt=True;TrustServerCertificate=True;"

      # OpenTelemetry: exporta via OTLP para o collector
      OTEL_SERVICE_NAME: "MoongyWebApp"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
      OTEL_EXPORTER_OTLP_PROTOCOL: "grpc"

      # Se sua app usa Application Insights SDK direto, você pode setar também:
      # APPLICATIONINSIGHTS_CONNECTION_STRING: "${APPLICATIONINSIGHTS_CONNECTION_STRING}"
    ports:
      - "8080:8080"

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: moongy-otel
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otelcol/config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP (se quiser)
    environment:
      # Se você preencher, ele exporta para o Azure Monitor / App Insights
      APPLICATIONINSIGHTS_CONNECTION_STRING: "${APPLICATIONINSIGHTS_CONNECTION_STRING}"

  jaeger:
    image: jaegertracing/all-in-one:1.57
    container_name: moongy-jaeger
    ports:
      - "16686:16686" # UI
    environment:
      COLLECTOR_OTLP_ENABLED: "true"

volumes:
  sql_data:
